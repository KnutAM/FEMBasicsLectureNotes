# /etc/nginx/conf.d/pluto.conf
server {
    server_name teaching.ims.chalmers.se;

    # Optional: serve a static landing page
    # root /usr/share/nginx/html;
    root /home/pluto/sites/FEMBasicsLectureNotes;

    # --- Custom landing page at "/" ---
    location = / {
        # serve static/index.html if it exists, otherwise fall back to Pluto
        try_files /static/index.html @pluto;
    }

    # --- Serve static HTML snapshots from ./static/ ---
    location ^~ /static/ {
        # Use alias so paths are crystal clear and this beats any regex locations
        alias /home/pluto/sites/FEMBasicsLectureNotes/static/;

        # Try exact file, then with .html, then 404
        try_files $uri $uri.html =404;
    }
    
    # Reverse proxy to Julia service on localhost:8080
    # location / {
    location @pluto {
        proxy_pass         http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
        proxy_read_timeout 3600;
    }

    location / {
        # if a real file exists under root, serve it, otherwise proxy
        try_files $uri @pluto;
    }

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/teaching.ims.chalmers.se/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/teaching.ims.chalmers.se/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}
server {
    if ($host = teaching.ims.chalmers.se) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name teaching.ims.chalmers.se;
    return 404; # managed by Certbot


}